# ライフタイム

前の演習を完了するために、`for`ループでの最大限の利便性のために`&TicketStore`に対する`IntoIterator`の実装を追加してみましょう。

まず、実装の最も「明らかな」部分を埋めることから始めましょう：

```rust
impl IntoIterator for &TicketStore {
    type Item = &Ticket;
    type IntoIter = // ここに何が入るか？

    fn into_iter(self) -> Self::IntoIter {
        self.tickets.iter()
    }
}
```

`type IntoIter`は何に設定すべきでしょうか？\
直感的には、`self.tickets.iter()`によって返される型、すなわち`Vec::iter()`によって返される型であるべきです。\
標準ライブラリのドキュメントをチェックすると、`Vec::iter()`は`std::slice::Iter`を返すことがわかります。
`Iter`の定義は：

```rust
pub struct Iter<'a, T> { /* フィールドは省略 */ }
```

`'a`は**ライフタイムパラメータ**です。

## ライフタイムパラメータ

ライフタイムは、参照（可変または不変）がどのくらい有効かを追跡するためにRustコンパイラが使用する**ラベル**です。\
参照のライフタイムは、それが参照する値のスコープによって制約されます。Rustは常にコンパイル時に、参照がそれが参照する値がドロップされた後に使用されないことを確認し、ダングリングポインタやuse-after-freeバグを回避します。

これは聞き覚えがあるはずです：所有権と借用について説明したときに、これらの概念がすでに動作しているのを見ました。
ライフタイムは、特定の参照がどのくらい有効かを**名前付け**する方法にすぎません。

複数の参照があり、それらが互いにどのように**関連している**かを明確にする必要がある場合、名前付けが重要になります。
`Vec::iter()`のシグネチャを見てみましょう：

```rust
impl <T> Vec<T> {
    // 若干簡略化
    pub fn iter<'a>(&'a self) -> Iter<'a, T> {
        // [...]
    }
}
```

`Vec::iter()`は`'a`という名前のライフタイムパラメータに対してジェネリックです。\
`'a`は`Vec`のライフタイムと`iter()`によって返される`Iter`のライフタイムを**結びつける**ために使用されます。
平易な言葉で言うと：`iter()`によって返される`Iter`は、それが作成された`Vec`参照（`&self`）より長生きできません。

これは重要です。なぜなら、前述したように`Vec::iter`は`Vec`の要素への**参照**上のイテレータを返すからです。
`Vec`がドロップされると、イテレータによって返される参照は無効になります。Rustはこれが起こらないことを確実にしなければならず、ライフタイムはこのルールを強制するためのツールです。

## ライフタイム省略

Rustには**ライフタイム省略ルール**と呼ばれる一連のルールがあり、多くの場合に明示的なライフタイム注釈を省略できます。
例えば、`Vec::iter`の定義は`std`のソースコードでは次のようになっています：

```rust
impl <T> Vec<T> {
    pub fn iter(&self) -> Iter<'_, T> {
        // [...]
    }
}
```

`Vec::iter()`のシグネチャには明示的なライフタイムパラメータはありません。
省略ルールは、`iter()`によって返される`Iter`のライフタイムが`&self`参照のライフタイムに結びついていることを意味します。
`'_`は`&self`参照のライフタイムの**プレースホルダー**と考えることができます。

ライフタイム省略に関する公式ドキュメントへのリンクについては[References](#references)セクションを参照してください。\
ほとんどの場合、明示的なライフタイム注釈を追加する必要がある場合はコンパイラが教えてくれるので、それに依存できます。

## References

- [std::vec::Vec::iter](https://doc.rust-lang.org/std/vec/struct.Vec.html#method.iter)
- [std::slice::Iter](https://doc.rust-lang.org/std/slice/struct.Iter.html)
- [Lifetime elision rules](https://doc.rust-lang.org/reference/lifetime-elision.html)